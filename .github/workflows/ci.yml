name: Build and Deploy

on:
  push:
    branches: [ "**" ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables based on branch
        run: |
          echo "ENV=dev" >> $GITHUB_ENV
          echo "VITE_API_BASE=http://localhost:8080" >> $GITHUB_ENV
          echo "VITE_CANONICAL=http://localhost:8080" >> $GITHUB_ENV
          echo "VITE_OG_URL=http://localhost:8080" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw clean package

  build-backend:
    name: Build and Push Docker Images to YC CR
    needs: build
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables based on branch
        run: |
          echo "ENV=prod" >> $GITHUB_ENV
          echo "VITE_API_BASE=https://portbuddy.dev" >> $GITHUB_ENV
          echo "VITE_CANONICAL=https://portbuddy.dev" >> $GITHUB_ENV
          echo "VITE_OG_URL=https://portbuddy.dev" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw clean package -pl web -pl eureka -pl gateway -pl net-proxy -pl server -pl ssl-service -am -DskipTests

      - name: Login to Yandex Cloud Container Registry
        id: login-cr
        uses: yc-actions/yc-cr-login@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_CR_JSON_CREDS }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Server
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-server
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-server:latest

      - name: Build and push Gateway
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-gateway
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-gateway:latest

      - name: Build and push Eureka
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-eureka
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-eureka:latest

      - name: Build and push Net Proxy
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-net-proxy
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-net-proxy:latest

      - name: Build and push SSL Service
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-ssl-service
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-ssl-service:latest

  build-portbuddy-docker:
    name: Build and Push CLI Images
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: extract_version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=latest" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw clean package -pl cli -am -DskipTests

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push CLI
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-cli
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            portbuddy/portbuddy:${{ steps.extract_version.outputs.VERSION }}
            portbuddy/portbuddy:latest

  build-portbuddy-native:
    name: Build Native CLI (${{ matrix.os }})
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            asset_name: portbuddy-linux-x64
            executable_path: cli/target/portbuddy
          - os: ubuntu-24.04-arm
            asset_name: portbuddy-linux-arm64
            executable_path: cli/target/portbuddy
          - os: macos-15-intel
            asset_name: portbuddy-macos-x64
            executable_path: cli/target/portbuddy
          - os: macos-latest
            asset_name: portbuddy-macos-arm64
            executable_path: cli/target/portbuddy
          - os: windows-latest
            asset_name: portbuddy-windows-x64.exe
            executable_path: cli/target/portbuddy.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: extract_version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=latest" >> $GITHUB_OUTPUT
          fi

      - name: Set up MSVC
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Set up GraalVM
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'
          cache: 'maven'

      - name: Build with Maven (Native Image)
        run: ./mvnw clean package -pl cli -am -DskipTests -Pnative

      - name: Prepare Artifact
        id: prepare_artifact
        shell: bash
        run: |
          cp ${{ matrix.executable_path }} ${{ matrix.asset_name }}
          if command -v shasum &> /dev/null; then
            SHA=$(shasum -a 256 ${{ matrix.asset_name }} | awk '{print $1}')
          elif command -v sha256sum &> /dev/null; then
            SHA=$(sha256sum ${{ matrix.asset_name }} | awk '{print $1}')
          else
            echo "No shasum or sha256sum found"
            exit 1
          fi
          echo "sha256=$SHA" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.asset_name }}
          tag_name: ${{ steps.extract_version.outputs.VERSION }}
          name: Release ${{ steps.extract_version.outputs.VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Tap
    needs: build-portbuddy-native
    if: startsWith(github.ref, 'refs/tags/v22')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Homebrew Tap
        uses: actions/checkout@v4
        with:
          repository: amak-tech/homebrew-portbuddy # REPLACE with your actual tap repository
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }} # Needs a PAT with 'repo' scope

      - name: Extract version
        id: extract_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update Formula
        run: |
          # Use values from build-native-cli outputs
          # Note: Accessing matrix outputs by job ID is complex. 
          # An easier way is to download them from the release if they are already there.
          # Or since we are in the same workflow, we can use 'gh release download'
          
          gh release download v${{ steps.extract_version.outputs.VERSION }} -p "portbuddy-macos-*" --repo ${{ github.repository }}
          
          if command -v shasum &> /dev/null; then
            ARM_SHA=$(shasum -a 256 portbuddy-macos-arm64 | awk '{print $1}')
            X64_SHA=$(shasum -a 256 portbuddy-macos-x64 | awk '{print $1}')
          else
            ARM_SHA=$(sha256sum portbuddy-macos-arm64 | awk '{print $1}')
            X64_SHA=$(sha256sum portbuddy-macos-x64 | awk '{print $1}')
          fi
          
          sed -i "s/version \".*\"/version \"${{ steps.extract_version.outputs.VERSION }}\"/" Formula/portbuddy.rb
          sed -i "/portbuddy-macos-arm64\"/{n;s/sha256 \".*\"/sha256 \"$ARM_SHA\"/;}" Formula/portbuddy.rb
          sed -i "/portbuddy-macos-x64\"/{n;s/sha256 \".*\"/sha256 \"$X64_SHA\"/;}" Formula/portbuddy.rb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/portbuddy.rb
          git commit -m "Update portbuddy to v${{ steps.extract_version.outputs.VERSION }}"
          git push
