name: Build and Deploy

on:
  push:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables based on branch
        run: |
          echo "ENV=dev" >> $GITHUB_ENV
          echo "VITE_API_BASE=http://localhost:8080" >> $GITHUB_ENV
          echo "VITE_CANONICAL=http://localhost:8080" >> $GITHUB_ENV
          echo "VITE_OG_URL=http://localhost:8080" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw clean package

  deploy-backend:
    name: Build and Push Docker Images to YC CR
    needs: build
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables based on branch
        run: |
          echo "ENV=prod" >> $GITHUB_ENV
          echo "VITE_API_BASE=https://portbuddy.dev" >> $GITHUB_ENV
          echo "VITE_CANONICAL=https://portbuddy.dev" >> $GITHUB_ENV
          echo "VITE_OG_URL=https://portbuddy.dev" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw clean package -pl web -pl eureka -pl gateway -pl net-proxy -pl server -pl ssl-service -am -DskipTests

      - name: Login to Yandex Cloud Container Registry
        id: login-cr
        uses: yc-actions/yc-cr-login@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_CR_JSON_CREDS }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Server
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-server
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-server:latest

      - name: Build and push Gateway
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-gateway
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-gateway:latest

      - name: Build and push Eureka
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-eureka
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-eureka:latest

      - name: Build and push Net Proxy
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-net-proxy
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-net-proxy:latest

      - name: Build and push SSL Service
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-ssl-service
          platforms: linux/amd64
          push: true
          tags: cr.yandex/${{ vars.CR_REGISTRY }}/port-buddy-ssl-service:latest

  deploy-cli:
    name: Build and Push CLI Images
    needs: build
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'
          cache: 'maven'

      - name: Build with Maven (Native Image)
        run: ./mvnw clean package -pl cli -am -DskipTests -Pnative

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push CLI
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile-cli
          platforms: linux/amd64,linux/arm64
          push: true
          tags: portbuddy/portbuddy:latest

  build-native-cli:
    name: Build Native CLI (${{ matrix.os }})
    needs: build
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            asset_name: port-buddy-linux-x64
            executable_path: cli/target/portbuddy
          - os: ubuntu-24.04-arm64
            asset_name: port-buddy-linux-arm64
            executable_path: cli/target/portbuddy
          - os: macos-15-intel
            asset_name: port-buddy-macos-x64
            executable_path: cli/target/portbuddy
          - os: macos-latest
            asset_name: port-buddy-macos-arm64
            executable_path: cli/target/portbuddy
          - os: windows-latest
            asset_name: port-buddy-windows-x64.exe
            executable_path: cli/target/portbuddy.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up MSVC
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Set up GraalVM
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'graalvm'
          cache: 'maven'

      - name: Build with Maven (Native Image)
        run: ./mvnw clean package -pl cli -am -DskipTests -Pnative

      - name: Prepare Artifact
        shell: bash
        run: |
          cp ${{ matrix.executable_path }} ${{ matrix.asset_name }}

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.asset_name }}
          tag_name: latest
          name: Latest Release
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
